---
title: "Stool Microbiome Analysis"
author: "Kristen James"
date: "11/5/2021"
output:
  html_document:
    toc: true
    toc_float: true
---

# About

**Project:** FL100

**About:** Preproccess the data by determining the best prevalence thresholds to use. Run "standard" microbiome analysis focusing on plasma TMAO. This includes alpha and beta diversity, ANCOM differential abundance, and DESeq2 differential abundance analyses. 

**Inputs:** Inputs include: 

1) TMAO phyloseq object. Recall, the data from Dr. Kable was filtered to taxa with 2% abundance, which removes technical noise. Therefore, the remaining data is believable. Further filtering we do will be driven by our interest in more prevalent taxa. Furthermore, we should not recalculate the alpha diversity statistics after our filtering because that would incorrectly describe the microbiome environment.
2) Master phenotype data

**Outputs:** Outputs include: 

1) Plots per section [expand as analysis goes final]
2) Tables [expand as analysis goes final]

**Sources:**

1) [Example using Negative Binomial in Microbiome Differential Abundance Testing](https://bioconductor.org/packages/devel/bioc/vignettes/phyloseq/inst/doc/phyloseq-mixture-models.html)
2) [Workflow for Microbiome Data Analysis: from raw reads to community analyses](https://bioconductor.org/help/course-materials/2017/BioC2017/Day1/Workshops/Microbiome/MicrobiomeWorkflowII.html#different_ordination_projections)
3) [Example of what descriptive microbiome stats to report in the results](https://pubmed.ncbi.nlm.nih.gov/28407784/)


# Set Up

```{r, warning=FALSE,message=FALSE}
library(DESeq2)
library(phyloseq)
library(ggplot2)
library(dplyr)
library(vegan)
```

```{r Load phyloseq object}
load("../../data/processed/microbiome/phyloseq_objects/PSOtmao_211108.RData") #PSOtmao
```

```{r Add meta data to phyloseq object}
# Add age_cat
sample_data(PSOtmao)$age_cat <- ifelse(sample_data(PSOtmao)$age < 34, 1,
                         ifelse(sample_data(PSOtmao)$age >= 34 & sample_data(PSOtmao)$age < 50, 2, 3))
sample_data(PSOtmao)$age_cat <- as.factor(sample_data(PSOtmao)$age_cat)
# Add bmi_cat
sample_data(PSOtmao)$bmi_cat <- ifelse(sample_data(PSOtmao)$bmi_final.x < 25, 1,
                         ifelse(sample_data(PSOtmao)$bmi_final.x >= 25 & sample_data(PSOtmao)$bmi_final.x < 30, 2, 3))
sample_data(PSOtmao)$bmi_cat <- as.factor(sample_data(PSOtmao)$bmi_cat)

# Make sure "below" is the reference factor
str(sample_data(PSOtmao)$tmao_mdn)
sample_data(PSOtmao)$tmao_mdn <- relevel(sample_data(PSOtmao)$tmao_mdn, ref = "below")

# Add TMAO quantiles
tmao_quantile <- quantile(sample_data(PSOtmao)$tmao)
sample_data(PSOtmao)$tmao_quantile <- ifelse(sample_data(PSOtmao)$tmao <= tmao_quantile[2], "Quantile1",
                             ifelse(sample_data(PSOtmao)$tmao > tmao_quantile[2] & sample_data(PSOtmao)$tmao <= tmao_quantile[3], "Quantile2",
                                   ifelse(sample_data(PSOtmao)$tmao > tmao_quantile[3] & sample_data(PSOtmao)$tmao <= tmao_quantile[4], "Quantile3", "Quantile4")))

# Factor it
sample_data(PSOtmao)$tmao_quantile = factor(sample_data(PSOtmao)$tmao_quantile)

# Add TMAO tertiles
tmao_tertile <- quantile(sample_data(PSOtmao)$tmao, c(0:3/3))
sample_data(PSOtmao)$tmao_tertile <- ifelse(sample_data(PSOtmao)$tmao <= tmao_tertile[2], "Tertile1",
                             ifelse(sample_data(PSOtmao)$tmao > tmao_tertile[2] & sample_data(PSOtmao)$tmao <= tmao_tertile[3], "Tertile2", "Tertile3"))
# Factor it
sample_data(PSOtmao)$tmao_tertile = factor(sample_data(PSOtmao)$tmao_tertile)
# Lookss good
table(sample_data(PSOtmao)$tmao_tertile)
```

# Preproccess

Table of read counts at the Phylum level. We will filter low abundant Phyla. We will also require that taxa are present in at least 10% of samples (at least 36 samples). We will then agglomerate at the Genus level. 

```{r Getting Familiar with Taxa Distributions}
print("The number of different bacteria at each phyla:")
table(tax_table(PSOtmao)[, "Phylum"])

# Prevalence - how many samples the taxa is observed in
prevdf = apply(X = otu_table(PSOtmao),
               MARGIN = ifelse(taxa_are_rows(PSOtmao), yes = 1, no = 2),
               FUN = function(x){sum(x > 0)})

prevdf = data.frame(Prevalence = prevdf,
                    TotalAbundance = taxa_sums(PSOtmao), # the total number of occurrences (even if only observed 50 times in 1 sample, the number would be 50)
                    tax_table(PSOtmao))

print("Table showing prevalence, total abundance, and taxonomy:")
prevdf[1:20,]

# Make table with mean prevalence, total prevalence
print("Table showing mean prevalencce and total prevalence per Phylum:")
plyr::ddply(prevdf, "Phylum", function(df_mb){cbind("Mean" = mean(df_mb$Prevalence),"Sum" = sum(df_mb$Prevalence))})

```
From the phylum table, we can see that p__Elusimicrobia, p__Spirochaetes, and p__Synergistetes have the same mean and sum, meaning they are only present in 1 sample. We are interested and confident in the more abundant taxa so manually filter them out. Per Dr. Kable's expert advice, she already filtered to 2% prevalence to remove technical error. We will increase the filtering to 5%, a common threshold in the literature. 

```{r Supervised Filtering 5%}
# Define prevalence threshold as 5% of total samples
prevalenceThreshold <- 0.05 * nsamples(PSOtmao)
cat("The 10% prevalence threshold is", prevalenceThreshold, "samples.", "\n")

# Execute prevalence filter, using `prune_taxa()` function
keepTaxa = rownames(prevdf)[(prevdf$Prevalence >= prevalenceThreshold)]
PSOtmao1 = prune_taxa(keepTaxa, PSOtmao)

print("The number of different bacteria at each phyla:")
table(tax_table(PSOtmao1)[, "Phylum"])

# Look at phylum level distributions
ggplot(prevdf, aes(TotalAbundance, Prevalence / nsamples(PSOtmao1),color=Phylum)) +
  geom_hline(yintercept = 0.05, alpha = 0.5, linetype = 2) +  # Include a guess for parameter
  geom_point(size = 2, alpha = 0.7) +
  scale_x_log10() +  
  xlab("Total Abundance") + 
  ylab("Prevalence [Frac. Samples]") +
  facet_wrap(~Phylum) + 
  theme(legend.position="none")

# Agglomerate taxa
PSOtmao1G = tax_glom(PSOtmao1, "Genus", NArm = TRUE)
```

Great. Do your due diligence and inspect each phyloseq object to see how the filtering and glomming steps changed the nubmer of taxonomy. 

```{r Phyloseq object inspection}
# Inspect the effect of each filtering step on the phyloseq object
PSOtmao
PSOtmao1
PSOtmao1G
```

Look at Genus level distributions of the bugs.

```{r Genus level distributions}
# Prevalence - how many samples the taxa is observed in
prevdf = apply(X = otu_table(PSOtmao1G),
               MARGIN = ifelse(taxa_are_rows(PSOtmao1G), yes = 1, no = 2),
               FUN = function(x){sum(x > 0)})

prevdf = data.frame(Prevalence = prevdf,
                    TotalAbundance = taxa_sums(PSOtmao1G), # the total number of occurrences (even if only observed 50 times in 1 sample, the number would be 50)
                    tax_table(PSOtmao1G))

print("Table showing prevalence, total abundance, and taxonomy:")
prevdf[1:10,]

# Family
ggplot(prevdf1, aes(TotalAbundance, Prevalence / nsamples(PSOtmao1G),color=Family)) +
  geom_hline(yintercept = 0.05, alpha = 0.5, linetype = 2) + # Include a guess for parameter
  geom_point(size = 1, alpha = 0.7) +
  scale_x_log10() +
  xlab("Total Abundance") +
  ylab("Prevalence [Frac. Samples]") +
  facet_wrap(~Family) +
  theme(legend.position="none")

# Genus - have to blow it up to make it useful
ggplot(prevdf1, aes(TotalAbundance, Prevalence / nsamples(PSOtmao1G),color=Genus)) +
  geom_hline(yintercept = 0.05, alpha = 0.5, linetype = 2) + # Include a guess for parameter
  geom_point(size = 1, alpha = 0.7) +
  scale_x_log10() +
  xlab("Total Abundance") +
  ylab("Prevalence [Frac. Samples]") +
  facet_wrap(~Genus) +
  theme(legend.position="none")
```

# Look for Outliers Using PCoA

We want to identify outlier taxa that might drive the statistical analyses. One way to do this is to look for outliers in the PCoA plot.

```{r PCoA for outliers}
PCoA_BC <- ordinate(PSOtmao1G, "PCoA", "bray")

# BC
# taxa is similar to species
taxa_plot <- plot_ordination(PSOtmao1G, PCoA_BC, type = "taxa")
taxa_plot
# It looks like there is an outlier in the top left corner of the plot. 
# Identify which taxa that bacteria is from and remove it. 
tp_data <- taxa_plot$data
plot(tp_data$Axis.2) # yes an outlier!
# Who is it?
outlier <- tp_data[tp_data$Axis.2 == max(tp_data$Axis.2), ] 
cat("Which genus is the outlier?", outlier$Genus, "\n")
```

Super interesting! The "outlier" is prevotella, which is interesting in the microbiome community as a marker of individuals who consume/live/have non-industrialized diets/environments/guts. We won't remove this bug afterall. 

Save

```{r save PSOtmao4G}
save(PSOtmao1, file = "../../data/processed/microbiome/phyloseq_objects/PSOtmao1_211118.RData")
save(PSOtmao1G, file = "../../data/processed/microbiome/phyloseq_objects/PSOtmao1G_211118.RData")
```

# Phylogenetic Abundance plots

## Family Plot of TMAO Quantile 

```{r Phylo Abundance Plot by TMAO Quantile}
# Agglomerate taxa
PSOtmao1F = tax_glom(PSOtmao1, "Family", NArm = TRUE)
PSOtmao1F.top10 <- microbiome::aggregate_top_taxa(PSOtmao1F, "Family", top = 10)

ps1F.10.family.comp <- microbiome::transform(PSOtmao1F.top10, transform="compositional")

plot.composition.relAbun <- microbiome::plot_composition(ps1F.10.family.comp,
                                             sample.sort = "Description",
                                             x.label = "tmao_quantile",
                                             group_by = "tmao_quantile",
                                             average_by = "tmao_quantile") +
  theme_minimal() +
  scale_fill_brewer("Family", palette = "Paired") + 
  ggtitle("Relative Abundance at Family Level")

plot.composition.relAbun
```

## Family Plot of TMAO Tertile 

```{r Tertiles}
# Agglomerate taxa
PSOtmao1F = tax_glom(PSOtmao1, "Family", NArm = TRUE)
PSOtmao1F.top10 <- microbiome::aggregate_top_taxa(PSOtmao1F, "Family", top = 10)
ps1F.10.family.comp <- microbiome::transform(PSOtmao1F.top10, transform="compositional")

plot.composition.relAbun <- microbiome::plot_composition(ps1F.10.family.comp,
                                             sample.sort = "Description",
                                             x.label = "tmao_tertile",
                                             group_by = "tmao_tertile",
                                             average_by = "tmao_tertile") +
  theme_minimal() +
  scale_fill_brewer("Family", palette = "Paired") + 
  ggtitle("Relative Abundance at Family Level")

plot.composition.relAbun

# Save
jpeg("../../Outputs/plots/microbiome/RelAbund_Fam_TMAOTertiles_2111.jpg", width = 4, height = 4, res = 300)
plot.composition.relAbun
dev.off()
```


# DESeq2

From the DESeq2 [documentation](https://bioconductor.org/packages/release/bioc/vignettes/DESeq2/inst/doc/DESeq2.html), "Note: In order to benefit from the default settings of the package, you should put the variable of interest at the end of the formula and make sure the control level is the first level."

From Dr. Kable's example, 

> # Test the impact of fiber cluster, accounting for covariates, using the log ratio test
dds.ratio.batcho = phyloseq_to_deseq2(ps.genus, ~ Batch + k4_cluster)
>
> # This performs a likelihood ratio test, which determines if the increased likelihood of the data in the full model, where we include all terms, is more than expected if the terms excluded in the reduced model are really zero. 
dds.ratio.batcho <- DESeq(dds.ratio.batcho, test="LRT", reduced = ~ Batch )
>
> # The p-value is based on the LRT (so the same for everything), but the contrasts give the right log2 fold change.
resultsNames(dds.ratio.batcho)
res.1v2.batcho <- results(dds.ratio.batcho, contrast=c("k4_cluster", "2", "1"))

## Factored by TMAO Median 
```{r DESeq2 analysis - TMAO median}
# Grab the sample data to easily check the structure of your covariates, age, sex, and BMI
sd <- sample_data(PSOtmao1G)
str(sd$sex)
str(sd$bmi_final.x)
# Factor sex, BMI okay
sample_data(PSOtmao1G)$sex = factor(sample_data(PSOtmao1G)$sex)

#~~~~~~~~~~~~~~~
# DESeq analysis
# TMAO median
#~~~~~~~~~~~~~~~
mb <- phyloseq_to_deseq2(PSOtmao1G, ~ sex + age + bmi_final.x + tmao_mdn)
mb.ratio <- DESeq(mb, test = "LRT", reduced = ~ sex + age + bmi_final.x) # remove variable of interest here, TMAO
res.ratio <- results(mb.ratio)
alpha = 0.05
alpha.big = 0.5
sigtab = res.ratio[which(res.ratio$padj < alpha.big), ]
sigtab = cbind(as(sigtab, "data.frame"), as(tax_table(PSOtmao1G)[rownames(sigtab), ], "matrix"))
sigtab$family_genus <- paste0(sigtab$Family, sigtab$Genus)
head(sigtab)

```

No results when we look at TMAO median and control for age, sex, and BMI.

## Factored by TMAO Tertile 

```{r DESeq2 analysis - TMAO tertile}

# DESeq analysis - tmao_tertile
mb <- phyloseq_to_deseq2(PSOtmao1G, ~ sex + age + bmi_final.x + tmao_tertile)
mb.ratio <- DESeq(mb, test = "LRT", reduced = ~ sex + age + bmi_final.x) # remove variable of interest here, TMAO
res.ratio <- results(mb.ratio, contrast = c("tmao_tertile", "Tertile1", "Tertile3")) # Look at most different tertiles
alpha = 0.05
sigtab = res.ratio[which(res.ratio$padj < alpha), ]
sigtab = cbind(as(sigtab, "data.frame"), as(tax_table(PSOtmao1G)[rownames(sigtab), ], "matrix"))
sigtab$family_genus <- paste0(sigtab$Family, sigtab$Genus)
head(sigtab)

#~~~~~~~~~~~~~~~
# Plot Results
#~~~~~~~~~~~~~~~
resOTU <- rownames(sigtab)
otuData <- as.data.frame(otu_table(PSOtmao1G))
otuData_desRes <- otuData[rownames(otuData) %in% resOTU,]
#otuData_desRes <- as.data.frame(t(otuData_desRes))
# Get sample data groupings
sampleData <- as.data.frame(sample_data(PSOtmao1G))
sampleData <- subset(sampleData, select = c(tmao_mdn, tmao_quantile, tmao_tertile, tmao))
# Get tax table
taxaData <- as.data.frame(tax_table(PSOtmao1G))
taxaData_res <- taxaData[rownames(taxaData) %in% resOTU,]
taxaData_res$OrderFamilyGenus <- paste0(taxaData_res$Order, taxaData_res$Family, taxaData_res$Genus)

# Merge
ggData <- merge(taxaData_res, otuData_desRes, by = 0)
rownames(ggData) <-  ggData$OrderFamilyGenus
ggData <- ggData[,-(1:9)]
ggData <- as.data.frame(t(ggData))
ggData <- merge(ggData, sampleData, by = 0)
rownames(ggData) <- ggData[,"Row.names"]
ggData <- subset(ggData, select = -c(Row.names))

# Loop Plot
nres <- length(resOTU)
for (i in 1:nres) { 
    print(ggplot(ggData, aes(x = tmao_tertile, y = log(ggData[,i]))) +
            geom_boxplot()+
            ylab(colnames(ggData)[i])) 
}

#~~~~~~~~~~~~~~~
# Plot Results Fold Change
#~~~~~~~~~~~~~~~
sigtabgen = subset(sigtab, !is.na(Genus))
# Phylum order
x = tapply(sigtabgen$log2FoldChange, sigtabgen$Phylum, function(x) max(x))
x = sort(x, TRUE)
sigtabgen$Phylum = factor(as.character(sigtabgen$Phylum), levels=names(x))
# Genus order
x = tapply(sigtabgen$log2FoldChange, sigtabgen$Genus, function(x) max(x))
x = sort(x, TRUE)
sigtabgen$Genus = factor(as.character(sigtabgen$Genus), levels=names(x))
ggplot(sigtabgen, aes(y=family_genus, x=log2FoldChange, color=Phylum)) + 
  geom_vline(xintercept = 0.0, color = "gray", size = 0.5) +
  geom_point(size=3) + 
  ylab("Taxonomy") +
  xlab("Log2 Fold Change") + 
  scale_color_brewer(palette = "Dark2") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust=0.5))
```

## Factored by TMAO Quantile 

```{r DESeq2 analysis - TMAO quantile}
# DESeq analysis - tmao_quantile
mb <- phyloseq_to_deseq2(PSOtmao1G, ~ sex + age + bmi_final.x + tmao_quantile)
mb.ratio <- DESeq(mb, test = "LRT", reduced = ~ sex + age + bmi_final.x) # remove variable of interest here, TMAO
res.ratio <- results(mb.ratio, contrast = c("tmao_quantile", "Quantile1", "Quantile4"))
alpha = 0.05
sigtab = res.ratio[which(res.ratio$padj < alpha), ]
sigtab = cbind(as(sigtab, "data.frame"), as(tax_table(PSOtmao1G)[rownames(sigtab), ], "matrix"))
sigtab$family_genus <- paste0(sigtab$Family, sigtab$Genus)
head(sigtab)

#~~~~~~~~~~~~~~~
# Plot Results
#~~~~~~~~~~~~~~~
resOTU <- rownames(sigtab)
otuData <- as.data.frame(otu_table(PSOtmao1G))
otuData_desRes <- otuData[rownames(otuData) %in% resOTU,]
#otuData_desRes <- as.data.frame(t(otuData_desRes))
# Get sample data groupings
sampleData <- as.data.frame(sample_data(PSOtmao1G))
sampleData <- subset(sampleData, select = c(tmao_mdn, tmao_quantile, tmao_tertile, tmao))
# Get tax table
taxaData <- as.data.frame(tax_table(PSOtmao1G))
taxaData_res <- taxaData[rownames(taxaData) %in% resOTU,]
taxaData_res$OrderFamilyGenus <- paste0(taxaData_res$Order, taxaData_res$Family, taxaData_res$Genus)

# Merge
ggData <- merge(taxaData_res, otuData_desRes, by = 0)
rownames(ggData) <-  ggData$OrderFamilyGenus
ggData <- ggData[,-(1:9)]
ggData <- as.data.frame(t(ggData))
ggData <- merge(ggData, sampleData, by = 0)
rownames(ggData) <- ggData[,"Row.names"]
ggData <- subset(ggData, select = -c(Row.names))

# Loop Plot
nres <- length(resOTU)
for (i in 1:nres) { 
    print(ggplot(ggData, aes(x = tmao_quantile, y = log(ggData[,i]))) +
            geom_boxplot()+
            ylab(colnames(ggData)[i])) 
}

#~~~~~~~~~~~~~~~
# Plot Results Fold Change
#~~~~~~~~~~~~~~~
sigtabgen = subset(sigtab, !is.na(Genus))
# Phylum order
x = tapply(sigtabgen$log2FoldChange, sigtabgen$Phylum, function(x) max(x))
x = sort(x, TRUE)
sigtabgen$Phylum = factor(as.character(sigtabgen$Phylum), levels=names(x))
# Genus order
x = tapply(sigtabgen$log2FoldChange, sigtabgen$Genus, function(x) max(x))
x = sort(x, TRUE)
sigtabgen$Genus = factor(as.character(sigtabgen$Genus), levels=names(x))
ggplot(sigtabgen, aes(y=family_genus, x=log2FoldChange, color=Phylum)) + 
  geom_vline(xintercept = 0.0, color = "gray", size = 0.5) +
  geom_point(size=3) + 
  ylab("Taxonomy") +
  xlab("Log2 Fold Change") + 
  scale_color_brewer(palette = "Dark2") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust=0.5))
```


# Alpha Diversity Analysis

We do not need to redo the alpha diversity calculations because the filtering we did was not to remove technical variation but instead to focus our analysis on the more common players (also so we can be more statistically confident using less scarce data). Note, if you did want to calculate alpha diversity, the command estimate_richness() can accomplish that for you. 

Check the distributions of the alpha diversity metrics and run the multiple linear regression models with covariates. 

```{r Original Alpha diversity stats}
# Load master pheno file
phen <- readRDS("../../data/processed/phenotype/Phenotypes_211108.rds")
phen <- subset(phen, select = -c(sex, age, age_cat, bmi_cat))

# Grab PSO sample data
df <- as(sample_data(PSOtmao1G), "data.frame")
# Merge
df2 <- merge(phen, df, by = 0)
row.names(df2) <- df2[,"Row.names"]
df2 <- subset(df2, select =-c(Row.names))

#~~~~~~~~~~~~~~~~
# Compute
#~~~~~~~~~~~~~~~~

# Check distribution
shapiro.test(df2$shannon) # not normal, proceed with caution
shapiro.test(log(df2$shannon))
# Run linear regression
summary(lm(tmao_log ~ shannon + sex*age + cystatinc_bd1, df2))

# Check distribution
shapiro.test(df2$faith_pd) # normal
# Run linear regression
summary(lm(tmao_log ~ faith_pd + sex*age + cystatinc_bd1, df2))

# Check distribution
shapiro.test(df2$pielou_e) # not normal, proceed with caution
# Run linear regression
summary(lm(tmao_log ~ pielou_e + sex*age + cystatinc_bd1, df2))

# Check distribution
shapiro.test(df2$observed_otus) # normal
# Run linear regression
summary(lm(tmao_log ~ observed_otus + sex*age + cystatinc_bd1, df2))
```

## Alpha Diversity Plots

Make plots that demonstrate the relationship between TMAO and the alpha-diversity metrics. 

```{r Original Alpha Diversity Plots}
# Shannon
y_variable <- "Shannon"
x_variable <- "Natural Log of TMAO (uM)"
mdn_cut <- log(median(df2$tmao.x))
# Plot
ggplot(df2, aes(x=tmao_log, y=shannon)) +
  geom_point(aes(shape=bmi_cat, color = age_cat)) +
  geom_vline(xintercept = mdn_cut, linetype = "dashed") +
  geom_smooth(method = "lm", se = FALSE, fullrange = F) +
  theme_minimal() + 
  ylab(y_variable) +
  xlab(x_variable) +
  labs(color = "Age bin", shape = "BMI bin") +
  scale_color_brewer(palette = "Dark2")

# Faith's Phylogenetic Diversity
y_variable <- "Faith's Phylogenetic Diversity"
x_variable <- "Natural Log of TMAO (uM)"
mdn_cut <- log(median(df2$tmao.x))
# Plot
ggplot(df2, aes(x=tmao_log, y=faith_pd)) +
  geom_point(aes(shape=bmi_cat, color = age_cat)) +
  geom_vline(xintercept = mdn_cut, linetype = "dashed") +
  geom_smooth(method = "lm", se = FALSE, fullrange = F) +
  theme_minimal() + 
  ylab(y_variable) +
  xlab(x_variable) +
  labs(color = "Age bin", shape = "BMI bin") +
  scale_color_brewer(palette = "Dark2")

# Pielou's Evenness
y_variable <- "Pielou's Evenness"
x_variable <- "Natural Log of TMAO (uM)"
mdn_cut <- log(median(df2$tmao.x))
# Plot
ggplot(df2, aes(x=tmao_log, y=pielou_e)) +
  geom_point(aes(shape=bmi_cat, color = age_cat)) +
  geom_vline(xintercept = mdn_cut, linetype = "dashed") +
  geom_smooth(method = "lm", se = FALSE, fullrange = F) +
  theme_minimal() + 
  ylab(y_variable) +
  xlab(x_variable) +
  labs(color = "Age bin", shape = "BMI bin") +
  scale_color_brewer(palette = "Dark2")

# Observed OTUs
y_variable <- "Observed OTUs"
x_variable <- "Natural Log of TMAO (uM)"
mdn_cut <- log(median(df2$tmao.x))
# Plot
ggplot(df2, aes(x=tmao_log, y=observed_otus)) +
  geom_point(aes(shape=bmi_cat, color = age_cat)) +
  geom_vline(xintercept = mdn_cut, linetype = "dashed") +
  geom_smooth(method = "lm", se = FALSE, fullrange = F) +
  theme_minimal() + 
  ylab(y_variable) +
  xlab(x_variable) +
  labs(color = "Age bin", shape = "BMI bin") +
  scale_color_brewer(palette = "Dark2")

```

# Beta Diversity Analysis

```{r Beta diversity calculations}
# PCoA
PCoA_WU <- ordinate(PSOtmao4G, "PCoA", "wunifrac")
PCoA_UnWU <- ordinate(PSOtmao4G, "PCoA", "uunifrac")
PCoA_BC <- ordinate(PSOtmao4G, "PCoA", "bray")

# Calculate distance matrix
dismax_wu = phyloseq::distance(PSOtmao4G, method="wunifrac", type = "samples")
dismax_uwu = phyloseq::distance(PSOtmao4G, method="unifrac", type = "samples")
dismax_bc = phyloseq::distance(PSOtmao4G, method="bray", type = "samples")

```


```{r Beta diversity stats}
# Get sample_data
df <- as(sample_data(PSOtmao4G), "data.frame")
df$tmao_mdn <- relevel(df$tmao_mdn, ref = "below")

#~~~~~~~~~~~
# Weighted
#~~~~~~~~~~~
# Beta dispersion
bdis <- betadisper(dismax_wu, df$tmao_mdn)
permutest(bdis) # NS, good
boxplot(bdis, las = 2)

# ADONIS (perMANOVA) analysis
adonis2(dismax_wu ~ tmao_log + sex:age + bmi_final.y, data=df, method = "wunifrac", perm=999) # .025

#~~~~~~~~~~~
# Unweighted
#~~~~~~~~~~~
# Beta dispersion
bdis <- betadisper(dismax_uwu, df$tmao_mdn)
permutest(bdis) # NS, good
boxplot(bdis, las = 2)

# ADONIS (perMANOVA) analysis
adonis2(dismax_uwu ~ tmao_log + sex:age + bmi_final.y, data=df, method = "unifrac", perm=999) # .001

#~~~~~~~~~~~
# BrayCurtis
#~~~~~~~~~~~
# Beta dispersion
bdis <- betadisper(dismax_bc, df$tmao_mdn)
permutest(bdis) # NS, good
boxplot(bdis, las = 2)

# ADONIS (perMANOVA) analysis
adonis2(dismax_bc ~ tmao_log + sex:age + bmi_final.y, data=df, method = "bray", perm=999) # .017

```

# ANCOM

## ANCOM2 no-covariate analysis

```{r ANCOM - genus level}
source("../../Rscripts/ancom_v2.1.R")

# OTU table
MicroData <- otu_table(PSOtmao1G)
MicroData <- as.data.frame(as.matrix(MicroData), stringsAsFactors = F)
# Add 1
#MicroData2 <- MicroData +1
#MicroData2 <- as.data.frame(as.matrix(t(MicroData2),stringsAsFactors = F))
#dim(MicroData2) # 103 x 98

# Load the phenotype data
#------------------------
# Perform ANCOM analysis
# Step 1: Data preprocessing
# OTU data
otu_data <- otu_table(PSOtmao1G)
otu_data <- as.data.frame(as.matrix(otu_data), stringsAsFactors = F)
otu_id <- rownames(otu_data)

# Metadata 
#df <- readRDS("../data_processed/mapping/Biocrates_mapping_BD1_210809.rds")
#df$p.Cresol.SO4_bd1_mdn <- plyr::revalue(df$p.Cresol.SO4_bd1_mdn, c("0" = "< Median", "1" = "> Median"))
# Subset
MetaData2 <- df2 %>% dplyr::select(c(tmao_mdn, age, sex, bmi_final))
MetaData2$Sample.ID <- rownames(MetaData2)


feature_table = otu_data; sample_var = "Sample.ID"; group_var = NULL
out_cut = 0.05; zero_cut = 0.95; lib_cut = 1000; neg_lb = FALSE # make zero_cut=0.95 to match criteria used for other metabolites
# Function
prepro = feature_table_pre_process(feature_table = feature_table,
                                   meta_data = MetaData2,
                                   sample_var = sample_var,
                                   group_var = NULL,
                                   out_cut = out_cut,
                                   zero_cut = zero_cut,
                                   lib_cut = lib_cut,
                                   neg_lb = neg_lb)

# Step 2: ANCOM
feature_table = prepro$feature_table 
meta_data = prepro$meta_data
struc_zero = prepro$structure_zeros

# Define variables for ANCOM
main_var = "tmao_mdn"; p_adj_method = "BH"; alpha = 0.05
adj_formula = NULL ; rand_formula = NULL
# Run ANCCOM
t_start = Sys.time()
res = ANCOM(feature_table = feature_table, 
            meta_data = meta_data, 
            struc_zero = struc_zero, 
            main_var = main_var, 
            p_adj_method = p_adj_method, 
            alpha = alpha, 
            adj_formula = adj_formula, 
            rand_formula = rand_formula)
t_end = Sys.time()
t_run = t_end - t_start 
t_run # around 5s

# Results
res$out
res$fig$data

# Step 3: Volcano Plot
# Number of taxa except structural zeros
n_taxa = ifelse(is.null(struc_zero), nrow(feature_table), sum(apply(struc_zero, 1, sum) == 0))
# Cutoff values for declaring differentially abundant taxa
cut_off = c(0.9 * (n_taxa -1), 0.8 * (n_taxa -1), 0.7 * (n_taxa -1), 0.6 * (n_taxa -1))
names(cut_off) = c("detected_0.9", "detected_0.8", "detected_0.7", "detected_0.6")

# Annotation data
dat_ann = data.frame(x = min(res$fig$data$x), y = cut_off["detected_0.7"], label = "W[0.7]")

fig = res$fig +  
  geom_hline(yintercept = cut_off["detected_0.7"], linetype = "dashed") + 
  geom_text(data = dat_ann, aes(x = x, y = y, label = label), 
            size = 4, vjust = -0.5, hjust = 0, color = "orange", parse = TRUE)
fig  

# ORGANIZE PLOT

TaxaData2 <- readRDS("../../data/processed/microbiome/phyloseq_inputs/merged-taxonomy-dada2-retrained.rds")
rownames(TaxaData2) <- TaxaData2$Feature.ID

ancomRes <- res$out

test <- merge(ancomRes, TaxaData2, by.x = "taxa_id", by.y = "Feature.ID", all.x = TRUE, all.y = FALSE)

# Make plot 
tempdata <- test[test$detected_0.6 == TRUE,] # 0.6 but can make 0.7
asv_id <- unique(tempdata$taxa_id)

MicroData4 <- feature_table[row.names(feature_table) %in% asv_id,]

# Rename to the taxonomy 
#MicroData5 <- as.data.frame(as.matrix(t(MicroData4)))
TaxaData3 <- TaxaData2 %>% dplyr::select(Order, Family, Genus)
# Make a unique naming column that incorporates multiple levels of taxonomy
TaxaData3$OrderFamilyGenus <- paste(TaxaData3$Order, TaxaData3$Family, TaxaData3$Genus)
rownames(TaxaData3) <- rownames(TaxaData2)
# Merge
MicroData5 <- merge(MicroData4, TaxaData3,
                    by=0, all.x = T, all.y = F)

row.names(MicroData5) <- MicroData5$OrderFamilyGenus

MicroData5 <- MicroData5 %>%  dplyr::select(-Order, -Family, -Genus, -OrderFamilyGenus, -Row.names)
MicroData5 <- as.data.frame(as.matrix(t(MicroData5)))

# Merge with the phenotype data 
MetaData3 <- MetaData2 %>% dplyr::select(tmao_mdn)

ggData <- merge(MetaData3, MicroData5, by =0)
row.names(ggData) <- ggData$Row.names
ggData <- ggData %>% dplyr::select(-Row.names)

# Gather the data
library(tidyr)
ggData2 <- gather(ggData,
                  key = "Taxa",
                  value = "Abundance",
                  -tmao_mdn)
                
ggData2$Abundance <- log(ggData2$Abundance)

# Plot it
p <- ggplot(data = ggData2,
            aes(x = Taxa, 
                y = Abundance,
                fill = tmao_mdn), 
            alpha = 0.1) +
  geom_boxplot(lwd=.25) +
  xlab(NULL) +
  ylab("Log of Taxa Abundance") +
  theme_bw() + # note order matters here - need bw to be before theme()
  theme(axis.text.y = element_text( hjust = 1),
        axis.text.x = element_text(angle = 60, hjust = 1),
        text=element_text(size=11))  +
  scale_fill_manual(values=c("#2D708EFF", "#B8DE29FF")) + 
  #scale_fill_viridis(discrete = TRUE) +
  #coord_flip() +
  labs(fill = "TMAO \n Classification")

p
```


## ANCOM2 covariate analysis

ANCOM2 lets you include covariates into the analysis. If we add the same covariates as in the DESeq2 analysis, do we get similar results? 

```{r ANCOM - genus level with covariates median}
source("../../Rscripts/ancom_v2.1.R")

# OTU table
MicroData <- otu_table(PSOtmao1G)
MicroData <- as.data.frame(as.matrix(MicroData), stringsAsFactors = F)
# Add 1
#MicroData2 <- MicroData +1
#MicroData2 <- as.data.frame(as.matrix(t(MicroData2),stringsAsFactors = F))
#dim(MicroData2) # 103 x 98

# Load the phenotype data
#------------------------
# Perform ANCOM analysis
# Step 1: Data preprocessing
# OTU data
otu_data <- otu_table(PSOtmao1G)
otu_data <- as.data.frame(as.matrix(otu_data), stringsAsFactors = F)
otu_id <- rownames(otu_data)

# Metadata 
#df <- readRDS("../data_processed/mapping/Biocrates_mapping_BD1_210809.rds")
#df$p.Cresol.SO4_bd1_mdn <- plyr::revalue(df$p.Cresol.SO4_bd1_mdn, c("0" = "< Median", "1" = "> Median"))
# Subset
MetaData2 <- df2 %>% dplyr::select(c(tmao_mdn, age, sex, bmi_final))
MetaData2$Sample.ID <- rownames(MetaData2)


feature_table = otu_data; sample_var = "Sample.ID"; group_var = NULL
out_cut = 0.05; zero_cut = 0.95; lib_cut = 1000; neg_lb = FALSE # make zero_cut=0.95 to match criteria used for other metabolites
# Function
prepro = feature_table_pre_process(feature_table = feature_table,
                                   meta_data = MetaData2,
                                   sample_var = sample_var,
                                   group_var = NULL,
                                   out_cut = out_cut,
                                   zero_cut = zero_cut,
                                   lib_cut = lib_cut,
                                   neg_lb = neg_lb)

# Step 2: ANCOM
feature_table = prepro$feature_table 
meta_data = prepro$meta_data
struc_zero = prepro$structure_zeros

# Define variables for ANCOM
main_var = "tmao_mdn"; p_adj_method = "BH"; alpha = 0.05
adj_formula = c("age + sex + bmi_final"); rand_formula = NULL
# Run ANCCOM
t_start = Sys.time()
res = ANCOM(feature_table = feature_table, 
            meta_data = meta_data, 
            struc_zero = struc_zero, 
            main_var = main_var, 
            p_adj_method = p_adj_method, 
            alpha = alpha, 
            adj_formula = adj_formula, 
            rand_formula = rand_formula)
t_end = Sys.time()
t_run = t_end - t_start 
t_run # around 5s

# Results
res$out
res$fig$data

# Step 3: Volcano Plot
# Number of taxa except structural zeros
n_taxa = ifelse(is.null(struc_zero), nrow(feature_table), sum(apply(struc_zero, 1, sum) == 0))
# Cutoff values for declaring differentially abundant taxa
cut_off = c(0.9 * (n_taxa -1), 0.8 * (n_taxa -1), 0.7 * (n_taxa -1), 0.6 * (n_taxa -1))
names(cut_off) = c("detected_0.9", "detected_0.8", "detected_0.7", "detected_0.6")

# Annotation data
dat_ann = data.frame(x = min(res$fig$data$x), y = cut_off["detected_0.7"], label = "W[0.7]")

fig = res$fig +  
  geom_hline(yintercept = cut_off["detected_0.7"], linetype = "dashed") + 
  geom_text(data = dat_ann, aes(x = x, y = y, label = label), 
            size = 4, vjust = -0.5, hjust = 0, color = "orange", parse = TRUE)
fig  

# ORGANIZE PLOT

TaxaData2 <- readRDS("../../data/processed/microbiome/phyloseq_inputs/merged-taxonomy-dada2-retrained.rds")
rownames(TaxaData2) <- TaxaData2$Feature.ID

ancomRes <- res$out

test <- merge(ancomRes, TaxaData2, by.x = "taxa_id", by.y = "Feature.ID", all.x = TRUE, all.y = FALSE)

# Make plot 
tempdata <- test[test$detected_0.6 == TRUE,] # 0.6 but can make 0.7
asv_id <- unique(tempdata$taxa_id)

MicroData4 <- feature_table[row.names(feature_table) %in% asv_id,]

# Rename to the taxonomy 
#MicroData5 <- as.data.frame(as.matrix(t(MicroData4)))
TaxaData3 <- TaxaData2 %>% dplyr::select(Order, Family, Genus)
# Make a unique naming column that incorporates multiple levels of taxonomy
TaxaData3$OrderFamilyGenus <- paste(TaxaData3$Order, TaxaData3$Family, TaxaData3$Genus)
rownames(TaxaData3) <- rownames(TaxaData2)
# Merge
MicroData5 <- merge(MicroData4, TaxaData3,
                    by=0, all.x = T, all.y = F)

row.names(MicroData5) <- MicroData5$OrderFamilyGenus

MicroData5 <- MicroData5 %>%  dplyr::select(-Order, -Family, -Genus, -OrderFamilyGenus, -Row.names)
MicroData5 <- as.data.frame(as.matrix(t(MicroData5)))

# Merge with the phenotype data 
MetaData3 <- MetaData2 %>% dplyr::select(tmao_mdn)

ggData <- merge(MetaData3, MicroData5, by =0)
row.names(ggData) <- ggData$Row.names
ggData <- ggData %>% dplyr::select(-Row.names)

# Gather the data
library(tidyr)
ggData2 <- gather(ggData,
                  key = "Taxa",
                  value = "Abundance",
                  -tmao_mdn)
                
ggData2$Abundance <- log(ggData2$Abundance)

# Plot it
p <- ggplot(data = ggData2,
            aes(x = Taxa, 
                y = Abundance,
                fill = tmao_mdn), 
            alpha = 0.1) +
  geom_boxplot(lwd=.25) +
  xlab(NULL) +
  ylab("Log of Taxa Abundance") +
  theme_bw() + # note order matters here - need bw to be before theme()
  theme(axis.text.y = element_text( hjust = 1),
        axis.text.x = element_text(angle = 60, hjust = 1),
        text=element_text(size=11))  +
  scale_fill_manual(values=c("#2D708EFF", "#B8DE29FF")) + 
  #scale_fill_viridis(discrete = TRUE) +
  #coord_flip() +
  labs(fill = "TMAO \n Classification")

p
```

Repeat looking at tertile 1 and 3. This section isn't currently working but I'm not sure why. 

```{r ANCOM - genus level with covariates tertile}
source("../../Rscripts/ancom_v2.1.R")

# OTU table
MicroData <- otu_table(PSOtmao1G)
MicroData <- as.data.frame(as.matrix(MicroData), stringsAsFactors = F)
# Add 1
#MicroData2 <- MicroData +1
#MicroData2 <- as.data.frame(as.matrix(t(MicroData2),stringsAsFactors = F))
#dim(MicroData2) # 103 x 98

# Load the phenotype data
#------------------------
# Perform ANCOM analysis
# Step 1: Data preprocessing
# OTU data
otu_data <- otu_table(PSOtmao1G)
otu_data <- as.data.frame(as.matrix(otu_data), stringsAsFactors = F)
otu_id <- rownames(otu_data)

# Metadata 
#df <- readRDS("../data_processed/mapping/Biocrates_mapping_BD1_210809.rds")
#df$p.Cresol.SO4_bd1_mdn <- plyr::revalue(df$p.Cresol.SO4_bd1_mdn, c("0" = "< Median", "1" = "> Median"))
# Subset
MetaData2 <- df2 %>% dplyr::select(c(tmao_mdn, age, sex, bmi_final))
MetaData2$Sample.ID <- rownames(MetaData2)


feature_table = otu_data; sample_var = "Sample.ID"; group_var = NULL
out_cut = 0.05; zero_cut = 0.95; lib_cut = 1000; neg_lb = FALSE # make zero_cut=0.95 to match criteria used for other metabolites
# Function
prepro = feature_table_pre_process(feature_table = feature_table,
                                   meta_data = MetaData2,
                                   sample_var = sample_var,
                                   group_var = NULL,
                                   out_cut = out_cut,
                                   zero_cut = zero_cut,
                                   lib_cut = lib_cut,
                                   neg_lb = neg_lb)

# Step 2: ANCOM
feature_table = prepro$feature_table 
meta_data = prepro$meta_data
struc_zero = prepro$structure_zeros

# Step 2.1: Tertile 1 and 3
tert1_3 <- df2[df2$tmao_tertile == "Tertile1" | df2$tmao_tertile == "Tertile3",]
feature_table = feature_table[,colnames(feature_table) %in% rownames(tert1_3)]
meta_data = meta_data[rownames(meta_data) %in% rownames(tert1_3),]

# Define variables for ANCOM
main_var = "tmao_tertile"; p_adj_method = "BH"; alpha = 0.05
adj_formula = c("age + sex + bmi_final"); rand_formula = NULL
# Run ANCCOM
t_start = Sys.time()
res = ANCOM(feature_table = feature_table, 
            meta_data = meta_data, 
            struc_zero = struc_zero, 
            main_var = main_var, 
            p_adj_method = p_adj_method, 
            alpha = alpha, 
            adj_formula = adj_formula, 
            rand_formula = rand_formula)
t_end = Sys.time()
t_run = t_end - t_start 
t_run # around 5s

# Results
res$out
res$fig$data

# Step 3: Volcano Plot
# Number of taxa except structural zeros
n_taxa = ifelse(is.null(struc_zero), nrow(feature_table), sum(apply(struc_zero, 1, sum) == 0))
# Cutoff values for declaring differentially abundant taxa
cut_off = c(0.9 * (n_taxa -1), 0.8 * (n_taxa -1), 0.7 * (n_taxa -1), 0.6 * (n_taxa -1))
names(cut_off) = c("detected_0.9", "detected_0.8", "detected_0.7", "detected_0.6")

# Annotation data
dat_ann = data.frame(x = min(res$fig$data$x), y = cut_off["detected_0.7"], label = "W[0.7]")

fig = res$fig +  
  geom_hline(yintercept = cut_off["detected_0.7"], linetype = "dashed") + 
  geom_text(data = dat_ann, aes(x = x, y = y, label = label), 
            size = 4, vjust = -0.5, hjust = 0, color = "orange", parse = TRUE)
fig  

# ORGANIZE PLOT

TaxaData2 <- readRDS("../../data/processed/microbiome/phyloseq_inputs/merged-taxonomy-dada2-retrained.rds")
rownames(TaxaData2) <- TaxaData2$Feature.ID

ancomRes <- res$out

test <- merge(ancomRes, TaxaData2, by.x = "taxa_id", by.y = "Feature.ID", all.x = TRUE, all.y = FALSE)

# Make plot 
tempdata <- test[test$detected_0.6 == TRUE,] # 0.6 but can make 0.7
asv_id <- unique(tempdata$taxa_id)

MicroData4 <- feature_table[row.names(feature_table) %in% asv_id,]

# Rename to the taxonomy 
#MicroData5 <- as.data.frame(as.matrix(t(MicroData4)))
TaxaData3 <- TaxaData2 %>% dplyr::select(Order, Family, Genus)
# Make a unique naming column that incorporates multiple levels of taxonomy
TaxaData3$OrderFamilyGenus <- paste(TaxaData3$Order, TaxaData3$Family, TaxaData3$Genus)
rownames(TaxaData3) <- rownames(TaxaData2)
# Merge
MicroData5 <- merge(MicroData4, TaxaData3,
                    by=0, all.x = T, all.y = F)

row.names(MicroData5) <- MicroData5$OrderFamilyGenus

MicroData5 <- MicroData5 %>%  dplyr::select(-Order, -Family, -Genus, -OrderFamilyGenus, -Row.names)
MicroData5 <- as.data.frame(as.matrix(t(MicroData5)))

# Merge with the phenotype data 
MetaData3 <- MetaData2 %>% dplyr::select(tmao_tertile)

ggData <- merge(MetaData3, MicroData5, by =0)
row.names(ggData) <- ggData$Row.names
ggData <- ggData %>% dplyr::select(-Row.names)

# Gather the data
library(tidyr)
ggData2 <- gather(ggData,
                  key = "Taxa",
                  value = "Abundance",
                  -tmao_tertile)
                
ggData2$Abundance <- log(ggData2$Abundance)

# Plot it
p <- ggplot(data = ggData2,
            aes(x = Taxa, 
                y = Abundance,
                fill = tmao_tertile), 
            alpha = 0.1) +
  geom_boxplot(lwd=.25) +
  xlab(NULL) +
  ylab("Log of Taxa Abundance") +
  theme_bw() + # note order matters here - need bw to be before theme()
  theme(axis.text.y = element_text( hjust = 1),
        axis.text.x = element_text(angle = 60, hjust = 1),
        text=element_text(size=11))  +
  scale_fill_manual(values=c("#2D708EFF", "#B8DE29FF")) + 
  #scale_fill_viridis(discrete = TRUE) +
  #coord_flip() +
  labs(fill = "TMAO \n Classification")

p
```


