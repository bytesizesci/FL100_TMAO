---
title: "Normalize Biocrates Data"
author: "Kristen James"
date: "11/2/2021"
output:
  html_document:
    toc: true
    toc_float: true
---

# About

**Project:** FL100

**About:** We received metabolomics data from the Newman lab run using Biocrates kits. The original file needs to be manipulated to make it data-science ready. Once we format the data for easier manipulation, we will assess its compliance to the normal distribution, per Dr. John Newman's suggestion. He suggested Johnson transformations or log transformations - we will proceed with log transformations because it is easier to understand.

**Inputs:** Biocrates data in a "messy" format.

**Outputs:** Outputs include the following:

1) Data-science approved Biocrates data, non-transformed, BD1 only [bio_bd1]
2) Data-science approved Biocrates data, non-transformed, BD1-4 long format [bio5]
3) Data-science approved Biocrates data, non-transformed, BD1-4 wide format, all cases including NAs [bd.all.w]
4) Data-science approved Biocrates data, non-transformed, BD1-4 wide format, complete cases only [bd.complete.w]
5) Data-science approved Biocrates data, natural log transformed, BD1 only [bio_bd1.ln2]
6) Data-science approved Biocrates data, natural log transformed, BD1-4 wide format, complete cases only[bd.complete.w.ln]

# Set Up

Load libraries.

```{r libraries, results='hide', message=FALSE}
library(dplyr)
```

Load data.

```{r load biocrates data, results='hide'}
# Load data from Jon Newman on 8/5/21
bio <- read.csv("../../data/raw/from_JohnNewman/Prelim_Biocretes_dataset_v3_corrected_PPTime.csv", na.strings=c(""," ","NA"))

bio[1:10,1:10]
```
# Preprocess

This file is ugly. It needs to be tailored before we can confidently maneuver in it. 

```{r Beautify biocrates file, results='hide'}
# Set column names
colnames(bio) <- bio[3,]

# Note, can't set row names to subject ID yet bc this data-set has multiple blood draws/person so IDs are not unique. 
# Will subset to BD1 in our first pass. See chunk below.

# Trim junk rows on top
dim(bio) #683 591
bio <- bio[4:677,] #674 591

# Use gsub to get rid of spaces in column names - YUCK!
colnames(bio)
colnames(bio) <- gsub(" ", "_", colnames(bio))
colnames(bio) <- gsub("-", "_", colnames(bio))


# Get rid of blank columns, if needed
emptycols <- sapply(bio, function (k) all(is.na(k)))
table(emptycols) # no empty cols now
bio2 <- bio[!emptycols]
dim(bio2) #674 591

# Look at structure
str(bio2) # Imported as chr. Not what we want. Check that out.
colnames(bio2[,1:10])
# First, subset to the columns we want to turn into numeric values
bio3 <- bio2[,c(7:length(bio2))]
# Then, lapply the combined character->numeric function to turn them into numbers
bio4 <- lapply(bio3, function(x) as.numeric(as.character(x)))
str(bio4)
# Finally, turn your list into a data frame using cbind
bio5 <- do.call(cbind.data.frame, bio4)

```

View handiwork. 
```{r View processed data}
head(bio5[,1:10])
```

So bio5 is in the long format - participants with blood draws at each time point have their ID listed multiple times in the subject ID column. Because there are ~340 people with BD1 and only ~100 people with BD2-4 we should create multiple objects. 

Subset to BD1 samples and set row names.

```{r Subset to biocrates BD1, results='hide'}
# Look at individuals by blood draw
table(bio5$pp_Time_min)
# Subset to BD1
bio_bd1 <- bio5[bio5$pp_Time_min == 0,]
head(bio_bd1[,1:10])

# Now set row names to subject ID
rownames(bio_bd1) <- bio_bd1[,"Subject_ID"]
bio_bd1 <- subset(bio_bd1, select = -c(Subject_ID))
```

Save cleaned Biocrates data for future use.

```{r Save Biocrates data}
# BD1
write.csv(bio_bd1, "../../data/processed/biocrates/FL100_biocrates_bd1_rawCounts_211102.csv")
saveRDS(bio_bd1, "../../data/processed/biocrates/FL100_biocrates_bd1_rawCounts_211102.rds")
# all data
write.csv(bio5, "../../data/processed/biocrates/FL100_biocrates_rawCounts_211102.csv")
saveRDS(bio5, "../../data/processed/biocrates/FL100_biocrates_rawCounts_211102.rds")
```

Another file format that will be useful to have is the BD1-4 long data. Reshape the wide data (bio5) and save. 

```{r Reshape BD1-4 long to wide}
# Give the object with BD1-4 a more useful name
bd.all.l <- bio5
# Make a wide data frame with the long data
bd.all.w <- reshape(bd.all.l, idvar = "Subject_ID", timevar = "pp_Time_min", direction = "wide")
# Set rownames, which reset during the reshape
rownames(bd.all.w) <- bd.all.w[,"Subject_ID"]
bd.all.w <- subset(bd.all.w, select = -c(Subject_ID))

# Check it out
colnames(bd.all.w[,1:10])
colnames(bd.all.w[,2330:2332])
head(bd.all.w[,585:590])

# Save
write.csv(bd.all.w, "../../data/processed/biocrates/FL100_biocrates_rawCounts_BD1-4_211103.csv")
saveRDS(bd.all.w, "../../data/processed/biocrates/FL100_biocrates_rawCounts_BD1-4_211103.rds")
```

The wide data looks good but once we get into BD2-4 there are a lot of NAs (simply because those samples weren't run at those time points). It will be nice to also have a complete (no NA) wide data frame as well as the full (all samples data frame). 

```{r subset to complete wide data}
# Who has complete TMAO data? 
bd.complete.w <- bd.all.w[complete.cases(bd.all.w$TMAO.0)==TRUE &
                            complete.cases(bd.all.w$TMAO.30)==TRUE &
                            complete.cases(bd.all.w$TMAO.180)==TRUE &
                            complete.cases(bd.all.w$TMAO.180)==TRUE,]

# Save
write.csv(bd.complete.w, "../../data/processed/biocrates/FL100_biocrates_rawCounts_BD1-4CompleteCases_211103.csv")
saveRDS(bd.complete.w, "../../data/processed/biocrates/FL100_biocrates_rawCounts_BD1-4CompleteCases_211103.rds")
```

# Transform

Recall, this data has gone through general QC by the Newman lab but it has not been assessed for compliance to the normal distribution. Next, we will complete log transformations and save output.

```{r Log transform BD1}
# Check data
bio_bd1[1:10,1:10] #C0 starts in column 3
dim(bio_bd1)

# Transform continuous columns
bio_bd1.ln <- log(bio_bd1[,2:584])

# Combine back with first 2 rows
bio_bd1.cat <- bio_bd1[,1, drop = FALSE]
bio_bd1.ln2 <- merge(bio_bd1.cat, bio_bd1.ln, by=0)
rownames(bio_bd1.ln2) <- bio_bd1.ln2[,"Row.names"] 
bio_bd1.ln2 <- subset(bio_bd1.ln2, select = -c(Row.names))

# Save bd1.ln2
write.csv(bio_bd1.ln2, "../../data/processed/biocrates/FL100_biocrates_lnTransformed_BD1_211103.csv")
saveRDS(bio_bd1.ln2, "../../data/processed/biocrates/FL100_biocrates_lnTransformed_BD1_211103.rds")
```

Log transform BD1-4 data

```{r Log transform BD1-4 complete data}
# Check data
bd.complete.w[1:10,1:10] #C0 starts in column 3
dim(bd.complete.w)

# Transform continuous columns
bd.complete.w.ln <- log(bd.complete.w)

# Save bd1.ln2
write.csv(bd.complete.w.ln, "../../data/processed/biocrates/FL100_biocrates_lnTransformed_BD1-4_CompleteCases_211103.csv")
saveRDS(bd.complete.w.ln, "../../data/processed/biocrates/FL100_biocrates_lnTransformed_BD1-4_CompleteCases_211103.rds")
```


We have an a priori hypothesis about select uremic toxins, TMAO, p-cresol-SO4, and indoxyl-sulfate. We will handle these variables more carefully. Assess their individual raw distributions, transform, and save.

```{r Uremic Toxins}
shapiro.test(bio_bd1$TMAO)
shapiro.test(bio_bd1$p_Cresol_SO4)
shapiro.test(bio_bd1$Ind_SO4)

shapiro.test(log(bio_bd1$TMAO))
shapiro.test(log(bio_bd1$p_Cresol_SO4))
shapiro.test(log(bio_bd1$Ind_SO4))

shapiro.test((bio_bd1$TMAO)^.5)
shapiro.test((bio_bd1$p_Cresol_SO4)^.5)
shapiro.test((bio_bd1$Ind_SO4)^.5)
```



